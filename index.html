<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flora's Store — Mobile POS</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* small tweak to make install prompt button visible if needed */
    .install-btn{display:none}
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
  <div class="max-w-2xl mx-auto">
    <header class="mb-4">
      <h1 class="text-xl font-semibold text-center">Flora's Store — Mobile POS</h1>
      <p class="text-xs text-center text-gray-500">Master list + cart + sales log. Installable as "Flora's Store".</p>
    </header>

    <!-- PRODUCT MASTER LIST (Top - mobile stacked) -->
    <section class="bg-white rounded-lg shadow p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-medium">Product Master List</h2>
        <div class="flex gap-2">
          <button id="exportProductsBtn" class="text-xs px-2 py-1 bg-indigo-600 text-white rounded">Export</button>
          <button id="clearProductsBtn" class="text-xs px-2 py-1 bg-red-500 text-white rounded">Clear</button>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2 mb-2">
        <input id="searchProduct" placeholder="Search product" class="col-span-2 border p-2 rounded" />
        <button id="newProductBtn" class="col-span-1 bg-green-600 text-white rounded p-2">New</button>
      </div>

      <div id="productList" class="space-y-2 max-h-48 overflow-auto"></div>

      <!-- Product Form Modal (hidden area) -->
      <div id="productFormWrap" class="mt-3 hidden">
        <div class="bg-gray-50 border rounded p-3">
          <label class="text-xs text-gray-700">Name</label>
          <input id="masterName" class="w-full border p-2 rounded mb-2" />

          <label class="text-xs text-gray-700">Unit</label>
          <div class="flex gap-2 mb-2">
            <select id="masterUnit" class="flex-1 border p-2 rounded"></select>
            <input id="masterCustomUnit" class="flex-1 border p-2 rounded hidden" placeholder="Custom unit" />
          </div>

          <label class="text-xs text-gray-700">Price</label>
          <input id="masterPrice" type="number" step="0.01" class="w-full border p-2 rounded mb-2" />

          <div class="flex gap-2 justify-end">
            <button id="saveMasterBtn" class="bg-blue-600 text-white rounded px-3 py-2">Save</button>
            <button id="cancelMasterBtn" class="bg-gray-200 rounded px-3 py-2">Cancel</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CART SECTION -->
    <section class="bg-white rounded-lg shadow p-4 mb-4">
      <h2 class="font-medium mb-2">Cart</h2>

      <div class="grid grid-cols-3 gap-2 mb-3">
        <select id="productSelect" class="col-span-2 border rounded p-2"></select>
        <button id="addFromMasterBtn" class="bg-blue-600 text-white rounded p-2">Add</button>

        <input id="cartPrice" type="number" step="0.01" placeholder="Price (editable)" class="col-span-1 border p-2 rounded" />
        <input id="cartQty" type="number" placeholder="Qty" class="col-span-1 border p-2 rounded" />
        <select id="cartUnit" class="col-span-1 border p-2 rounded"></select>
      </div>

      <div class="overflow-auto mb-3">
        <table class="w-full text-sm" id="cartTable">
          <thead class="text-left text-gray-600">
            <tr>
              <th class="pb-2">Item</th>
              <th class="pb-2">Unit</th>
              <th class="pb-2">Price</th>
              <th class="pb-2">Qty</th>
              <th class="pb-2">Subtotal</th>
              <th class="pb-2">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs text-gray-500">Total</div>
          <div id="totalAmount" class="text-xl font-bold">₱0.00</div>
        </div>
        <div class="flex gap-2">
          <button id="finalizeBtn" class="bg-green-600 text-white rounded px-3 py-2">Finalize</button>
          <button id="printBtn" class="bg-yellow-400 rounded px-3 py-2">Print</button>
          <button id="exportSalesBtn" class="bg-indigo-600 text-white rounded px-3 py-2">Export</button>
        </div>
      </div>
    </section>

    <!-- SALES LOG -->
    <section class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-medium">Sales Log</h2>
        <button id="clearSalesLogBtn" class="text-xs px-2 py-1 bg-red-500 text-white rounded">Clear</button>
      </div>
      <div id="salesLogList" class="text-xs max-h-48 overflow-auto text-gray-700"></div>
    </section>

    <footer class="text-center text-xs text-gray-500">Data stored locally. Export regularly for backup.</footer>
  </div>

  <script>
  // PWA install prompt handling
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const btns = document.getElementsByClassName('install-btn');
    for(let b of btns) b.style.display = 'inline-block';
  });

  async function promptInstall(){
    if(!deferredPrompt) return false;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    return outcome === 'accepted';
  }
  </script>

  <!-- app logic (same as before) -->
  <script>
  // STORAGE KEYS
  const PRODUCTS_KEY = 'pos_products_v3';
  const UNITS_KEY = 'pos_units_v3';
  const SALES_KEY = 'pos_sales_v3';
  
  // State
  let products = []; // {id,name,unit,price}
  let units = ['pcs','box','pack','kg','liter','set','custom'];
  let cart = []; // {name,unit,price,qty,sourceProductId|null}
  let editingMasterId = null;
  
  // DOM refs
  const productList = document.getElementById('productList');
  const productSelect = document.getElementById('productSelect');
  const cartTableBody = document.querySelector('#cartTable tbody');
  const totalAmountEl = document.getElementById('totalAmount');
  const productFormWrap = document.getElementById('productFormWrap');
  const masterUnit = document.getElementById('masterUnit');
  const masterCustomUnit = document.getElementById('masterCustomUnit');
  const cartUnit = document.getElementById('cartUnit');
  
  // INIT
  function init(){
    loadFromStorage();
    renderUnitsToSelects();
    renderProductList();
    renderProductSelect();
    bindUI();
    renderCart();
    renderSalesLog();
  }
  
  function loadFromStorage(){
    products = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '[]');
    units = JSON.parse(localStorage.getItem(UNITS_KEY) || JSON.stringify(units));
    if(!units.includes('custom')) units.push('custom');
  }
  
  function saveProducts(){ localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products)); }
  function saveUnits(){ localStorage.setItem(UNITS_KEY, JSON.stringify(units)); }
  function saveSales(sales){ localStorage.setItem(SALES_KEY, JSON.stringify(sales)); }
  
  function renderUnitsToSelects(){
    [masterUnit, cartUnit].forEach(sel=>{
      sel.innerHTML = '';
      units.forEach(u=>{
        const opt = document.createElement('option'); opt.value = u; opt.textContent = u; sel.appendChild(opt);
      });
    });
  }
  
  // PRODUCT MASTER
  function renderProductList(filter=''){
    productList.innerHTML = '';
    const list = products.filter(p=> p.name.toLowerCase().includes(filter.toLowerCase()));
    if(list.length===0){ productList.innerHTML = '<div class="text-xs text-gray-400">No products yet.</div>'; return; }
    list.forEach(p=>{
      const wrap = document.createElement('div');
      wrap.className = 'flex items-center justify-between border-b py-2';
      wrap.innerHTML = `
        <div>
          <div class="font-medium">${p.name}</div>
          <div class="text-xs text-gray-500">${p.unit} · ₱${Number(p.price).toFixed(2)}</div>
        </div>
        <div class="flex gap-2">
          <button class="text-xs px-2 py-1 bg-yellow-300 rounded" onclick="openEditMaster('${p.id}')">Edit</button>
          <button class="text-xs px-2 py-1 bg-red-200 rounded" onclick="deleteProduct('${p.id}')">Delete</button>
        </div>`;
      productList.appendChild(wrap);
    });
  }
  
  function renderProductSelect(){
    productSelect.innerHTML = '';
    const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='Select product...'; productSelect.appendChild(placeholder);
    products.forEach(p=>{
      const opt = document.createElement('option'); opt.value = p.id; opt.textContent = `${p.name} — ₱${Number(p.price).toFixed(2)}`; productSelect.appendChild(opt);
    });
  }
  
  function bindUI(){
    document.getElementById('newProductBtn').addEventListener('click', ()=>openNewMaster());
    document.getElementById('cancelMasterBtn').addEventListener('click', ()=>closeMasterForm());
    document.getElementById('saveMasterBtn').addEventListener('click', ()=>saveMaster());
    document.getElementById('addFromMasterBtn').addEventListener('click', ()=>addFromMaster());
    document.getElementById('productSelect').addEventListener('change', onProductSelectChange);
    document.getElementById('searchProduct').addEventListener('input', e=>renderProductList(e.target.value));
    document.getElementById('finalizeBtn').addEventListener('click', finalizeSale);
    document.getElementById('printBtn').addEventListener('click', ()=>printReceipt());
    document.getElementById('exportSalesBtn').addEventListener('click', exportSalesLog);
    document.getElementById('clearProductsBtn').addEventListener('click', clearProducts);
    document.getElementById('exportProductsBtn').addEventListener('click', exportProducts);
    document.getElementById('clearSalesLogBtn').addEventListener('click', clearSalesLog);
  }
  
  function openNewMaster(){
    editingMasterId = null;
    productFormWrap.classList.remove('hidden');
    document.getElementById('masterName').value = '';
    masterUnit.value = units[0] || 'pcs';
    masterCustomUnit.value = '';
    masterCustomUnit.classList.add('hidden');
    document.getElementById('masterPrice').value = '';
  }
  
  function openEditMaster(id){
    const p = products.find(x=>x.id===id); if(!p) return;
    editingMasterId = id;
    productFormWrap.classList.remove('hidden');
    document.getElementById('masterName').value = p.name;
    if(!units.includes(p.unit)) { units.splice(units.length-1,0,p.unit); saveUnits(); renderUnitsToSelects(); }
    masterUnit.value = p.unit;
    masterCustomUnit.value = '';
    if(masterUnit.value === 'custom') masterCustomUnit.classList.remove('hidden'); else masterCustomUnit.classList.add('hidden');
    document.getElementById('masterPrice').value = p.price;
  }
  
  masterUnit.addEventListener('change', ()=>{
    if(masterUnit.value === 'custom') masterCustomUnit.classList.remove('hidden'); else masterCustomUnit.classList.add('hidden');
  });
  
  function closeMasterForm(){ productFormWrap.classList.add('hidden'); editingMasterId = null; }
  
  function saveMaster(){
    const name = document.getElementById('masterName').value.trim();
    let unit = masterUnit.value;
    const custom = masterCustomUnit.value.trim();
    const price = parseFloat(document.getElementById('masterPrice').value);
    if(unit === 'custom' && custom) unit = custom;
    if(unit && !units.includes(unit)) { units.splice(units.length-1,0,unit); saveUnits(); renderUnitsToSelects(); }
    if(!name || isNaN(price)) { alert('Please provide name and price'); return; }
    if(editingMasterId){
      const idx = products.findIndex(p=>p.id===editingMasterId);
      if(idx>=0){ products[idx].name = name; products[idx].unit = unit; products[idx].price = price; }
    } else {
      products.push({ id: 'P' + Date.now(), name, unit, price });
    }
    saveProducts(); renderProductList(); renderProductSelect(); renderUnitsToSelects(); closeMasterForm();
  }
  
  function deleteProduct(id){ if(!confirm('Delete product?')) return; products = products.filter(p=>p.id!==id); saveProducts(); renderProductList(); renderProductSelect(); }
  
  // CART
  function onProductSelectChange(){
    const id = productSelect.value;
    if(!id) return;
    const p = products.find(x=>x.id===id);
    if(!p) return;
    document.getElementById('cartPrice').value = p.price;
    document.getElementById('cartQty').value = 1;
    if(!units.includes(p.unit)){ units.splice(units.length-1,0,p.unit); saveUnits(); renderUnitsToSelects(); }
    cartUnit.value = p.unit;
  }
  
  function addFromMaster(){
    const id = productSelect.value; if(!id){ alert('Please select a product'); return; }
    const p = products.find(x=>x.id===id);
    if(!p) return;
    const price = parseFloat(document.getElementById('cartPrice').value);
    const qty = parseInt(document.getElementById('cartQty').value);
    let unit = cartUnit.value;
    if(!p) return;
    if(!unit) unit = p.unit || 'pcs';
    if(isNaN(price) || isNaN(qty)) { alert('Invalid price or quantity'); return; }
    cart.push({ name: p.name, unit, price, qty, sourceProductId: p.id });
    renderCart();
  }
  
  function renderCart(){
    cartTableBody.innerHTML = '';
    let total = 0;
    cart.forEach((it, idx)=>{
      total += it.price * it.qty;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="py-1">${escapeHtml(it.name)}</td>
        <td class="py-1">${escapeHtml(it.unit)}</td>
        <td class="py-1">₱${Number(it.price).toFixed(2)}</td>
        <td class="py-1">${it.qty}</td>
        <td class="py-1">₱${(it.price*it.qty).toFixed(2)}</td>
        <td class="py-1"><div class="flex gap-1"><button class='text-xs px-2 py-1 bg-yellow-200 rounded' onclick="editCartItem(${idx})">Edit</button><button class='text-xs px-2 py-1 bg-red-200 rounded' onclick="removeCartItem(${idx})">Remove</button></div></td>
      `;
      cartTableBody.appendChild(tr);
    });
    totalAmountEl.textContent = '₱' + total.toFixed(2);
  }
  
  function editCartItem(idx){
    const it = cart[idx];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-1"><input id="editName_${idx}" class="border p-1 rounded w-full" value="${escapeHtml(it.name)}" /></td>
      <td class="py-1"><select id="editUnit_${idx}" class="border p-1 rounded w-full"></select></td>
      <td class="py-1"><input id="editPrice_${idx}" type="number" step="0.01" class="border p-1 rounded w-full" value="${Number(it.price).toFixed(2)}" /></td>
      <td class="py-1"><input id="editQty_${idx}" type="number" class="border p-1 rounded w-full" value="${it.qty}" /></td>
      <td class="py-1" id="editSubtotal_${idx}">₱${(it.price*it.qty).toFixed(2)}</td>
      <td class="py-1"><div class="flex gap-1"><button class='text-xs px-2 py-1 bg-green-200 rounded' onclick="saveCartEdit(${idx})">Save</button><button class='text-xs px-2 py-1 bg-gray-200 rounded' onclick="renderCart()">Cancel</button></div></td>
    `;
    cartTableBody.querySelectorAll('tr')[idx].replaceWith(tr);
    const sel = document.getElementById(`editUnit_${idx}`);
    units.forEach(u=>{ const o = document.createElement('option'); o.value = u; o.textContent = u; sel.appendChild(o); });
    if(!units.includes(it.unit)) { const o = document.createElement('option'); o.value = it.unit; o.textContent = it.unit; sel.insertBefore(o, sel.querySelector('option[value="custom"]') || null); }
    sel.value = it.unit;
    const priceInput = document.getElementById(`editPrice_${idx}`);
    const qtyInput = document.getElementById(`editQty_${idx}`);
    function updateSub(){ const p = parseFloat(priceInput.value||0); const q = parseInt(qtyInput.value||0); document.getElementById(`editSubtotal_${idx}`).textContent = '₱' + (p*q).toFixed(2); }
    priceInput.addEventListener('input', updateSub); qtyInput.addEventListener('input', updateSub);
  }
  
  function saveCartEdit(idx){
    const name = document.getElementById(`editName_${idx}`).value.trim();
    const unit = document.getElementById(`editUnit_${idx}`).value;
    const price = parseFloat(document.getElementById(`editPrice_${idx}`).value);
    const qty = parseInt(document.getElementById(`editQty_${idx}`).value);
    if(!name || isNaN(price) || isNaN(qty)) { alert('Invalid values'); return; }
    if(unit && !units.includes(unit) && unit!=='custom'){ units.splice(units.length-1,0,unit); saveUnits(); renderUnitsToSelects(); }
    cart[idx].name = name; cart[idx].unit = unit; cart[idx].price = price; cart[idx].qty = qty;
    renderCart();
  }
  
  function removeCartItem(idx){ if(confirm('Remove this item?')){ cart.splice(idx,1); renderCart(); } }
  
  // FINALIZE & SALES LOG
  function finalizeSale(){
    if(cart.length===0){ alert('Cart empty'); return; }
    const now = new Date();
    const tx = { id: 'TX' + Date.now(), datetime: now.toLocaleString(), items: cart.map(i=>({ name:i.name, unit:i.unit, price:i.price, qty:i.qty, subtotal:i.price*i.qty, sourceProductId:i.sourceProductId || null })), total: cart.reduce((s,i)=>s + i.price*i.qty,0) };
    let sales = JSON.parse(localStorage.getItem(SALES_KEY) || '[]');
    sales.push(tx); saveSales(sales);
    cart = []; renderCart(); renderSalesLog(); alert('Sale saved to sales log');
  }
  
  function renderSalesLog(){ const wrap = document.getElementById('salesLogList'); wrap.innerHTML = ''; const sales = JSON.parse(localStorage.getItem(SALES_KEY)||'[]'); if(sales.length===0){ wrap.innerHTML = '<div class="text-xs text-gray-400">No sales yet.</div>'; return; } sales.slice().reverse().forEach(s=>{ const d = document.createElement('div'); d.className='border-b py-2'; d.innerHTML = `<div class="text-xs font-medium">${s.id} · ${s.datetime}</div><div class="text-xs text-gray-600">${s.items.map(it=>`${it.name}(${it.qty} ${it.unit})`).join(', ')} — ₱${Number(s.total).toFixed(2)}</div>`; wrap.appendChild(d); }); }
  
  // EXPORTS & PRINT
  function exportSalesLog(){ const sales = JSON.parse(localStorage.getItem(SALES_KEY)||'[]'); if(sales.length===0){ alert('No sales to export'); return; } const rows=[]; sales.forEach(tx=>{ tx.items.forEach(it=> rows.push({ 'Transaction ID': tx.id, 'Date & Time': tx.datetime, 'Product': it.name, 'Unit': it.unit, 'Price': it.price, 'Quantity': it.qty, 'Subtotal': it.subtotal, 'Transaction Total': tx.total })); }); const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'SalesLog'); XLSX.writeFile(wb, 'sales_log.xlsx'); }
  
  function exportProducts(){ if(products.length===0){ alert('No products'); return; } const rows = products.map(p=>({ ID:p.id, Name:p.name, Unit:p.unit, Price:p.price })); const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Products'); XLSX.writeFile(wb, 'products.xlsx'); }
  
  function clearProducts(){ if(!confirm('Clear all products?')) return; products=[]; saveProducts(); renderProductList(); renderProductSelect(); }
  function clearSalesLog(){ if(!confirm('Clear sales log?')) return; localStorage.removeItem(SALES_KEY); renderSalesLog(); }
  
  // PRINT
  function printReceipt(){ const url = URL.createObjectURL(new Blob([buildReceiptHtml(cart)],{type:'text/html'})); const w = window.open(url,'_blank'); setTimeout(()=>{ w.print(); },400); }
  function buildReceiptHtml(items){ let html = `
    <html><head><meta charset="utf-8"><title>Receipt</title>
    <style>body{font-family:Arial;padding:10px;}table{width:100%;border-collapse:collapse;}td{padding:4px}</style>
    </head><body>
    <h3>Flora's Store</h3>
    <div>${new Date().toLocaleString()}</div>
    <hr>
    <table>`;
    items.forEach(it=> html += `<tr><td>${escapeHtml(it.name)} (${escapeHtml(it.unit)})</td><td style="text-align:right">${it.qty} x ₱${Number(it.price).toFixed(2)}</td><td style="text-align:right">₱${(it.price*it.qty).toFixed(2)}</td></tr>`);
    const total = items.reduce((s,i)=>s + i.price*i.qty,0);
    html += `</table><hr><h3>Total: ₱${total.toFixed(2)}</h3></body></html>`;
    return html;
  }
  
  // HELPERS
  function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  
  // INITIALIZE
  init();
  </script>

  <!-- Service worker register -->
  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registered')).catch(e=>console.log('SW failed', e));
    }
  </script>
</body>
</html>